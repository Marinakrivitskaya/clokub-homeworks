# Домашнее задание к занятию 15.2 "Вычислительные мощности. Балансировщики нагрузки".

Используя конфигурации, выполненные в рамках ДЗ на предыдущем занятии добавить к Production like сети Autoscaling group из 2 EC2-инстансов с  автоматической установкой web-сервера в private домен. Создать приватный домен в Route53, чтобы был доступ из VPN.

## Задание 1. Создать bucket S3 и разместить там файл с картинкой.

- Создать бакет в S3 с произвольным именем (например, имя_студента_дата).
- Положить в бакет файл с картинкой.
- Сделать доступным из VPN используя ACL.

---

## Задание 2. Создать запись в Route53 домен с возможностью определения из VPN.

- Сделать запись в Route53 на приватный домен, указав адрес LB.

---

## Задание 3. Загрузить несколько ЕС2-инстансов с веб-страницей, на которой будет картинка из S3.

- Сделать Launch configurations с использованием bootstrap скрипта с созданием веб-странички на которой будет ссылка на картинку в S3.
- Загрузить 3 ЕС2-инстанса и настроить LB с помощью Autoscaling Group.


```tf
1. Security groups

resource "aws_security_group" "security_group" {
  name   = "security_group"
  vpc_id = module.vpc.vpc_id
  egress {
    protocol    = -1
    from_port   = 0
    to_port     = 0
    cidr_blocks = ["0.0.0.0/0"]
  }
}

resource "aws_security_group_rule" "ssh" {
  type              = "ingress"
  from_port         = 22
  to_port           = 22
  protocol          = "tcp"
  cidr_blocks       = ["0.0.0.0/0"]
  security_group_id = aws_security_group.security_group.id
}

resource "aws_security_group_rule" "http" {
  type              = "ingress"
  from_port         = 80
  to_port           = 80
  protocol          = "tcp"
  cidr_blocks       = ["0.0.0.0/0"]
  security_group_id = aws_security_group.security_group.id
}

resource "aws_security_group_rule" "https" {
  type              = "ingress"
  from_port         = 443
  to_port           = 443
  protocol          = "tcp"
  cidr_blocks       = ["0.0.0.0/0"]
  security_group_id = aws_security_group.security_group.id
}

2. S3

resource "aws_s3_bucket" "bucket" {
  bucket = “netology-krivitskaya"
  acl    = "private"
  versioning {
    enabled = false
  }
  tags = { 
  Name = "My bucket" }
}

resource "aws_s3_bucket_object" “my_img" {
  bucket = "netology-krivitskaya"
  acl    = "public-read"
  key    = “my_photo.png"
  source = “my_photo.png"
}

3. Route 53

resource "aws_route53_zone" "dns" {
  name = "dns-to-bucket.local"
  vpc {
    vpc_id = module.vpc.vpc_id
  }
}

resource "aws_route53_record" "www" {
  zone_id = aws_route53_zone.dns.zone_id
  name    = "www.dns-to-bucket.local"
  type    = "CNAME"
  ttl     = "300"
  records = [aws_elb.elb.dns_name]
}

4. EC2

data "aws_ami" "aws_ubuntu" {
  most_recent = true
  filter {
    name   = "name"
    values = ["ubuntu/images/hvm-ssd/ubuntu-trusty-14.04-amd64-server-*"]
  }
  filter {
    name   = "virtualization-type"
    values = ["hvm"]
  }
  owners = ["099720109477"]
}
data "template_file" "bootstrap" {
  template =  "$file("bootstrap.tpl")"
  vars = {
    url  = data.aws_s3_bucket.bucket.bucket_domain_name
    file = data.aws_s3_bucket_object.my_img.key
  }
}

resource "aws_launch_configuration" "as_conf" {
  name_prefix                 = "dz-"
  image_id                    = data.aws_ami.amazon-linux.id
  instance_type               = "t3.micro"
  security_groups             = [aws_security_group.security_group.id]
  key_name                    = "key1"
  associate_public_ip_address = true
  //bootstrap
  user_data = data.template_file.bootstrap.rendered
}

resource "aws_elb" "elb" {
  name    = "elb"
  subnets = [aws_subnet.public.id, aws_subnet.private.id]
  listener {
    instance_port     = 80
    instance_protocol = "http"
    lb_port           = 80
    lb_protocol       = "http"
  }
  security_groups             = [aws_security_group.security_group.id]
  cross_zone_load_balancing   = true
  idle_timeout                = 400
  connection_draining         = true
  connection_draining_timeout = 400
  tags = {
    Name = "elb"
  }
}

resource "aws_autoscaling_group" "autoscaling_group" {
  name                 = "autoscaling_group"
  launch_configuration = aws_launch_configuration.as_conf.name
  min_size             = 2
  max_size             = 6
  vpc_zone_identifier  = [aws_subnet.public.id, aws_subnet.public2.id, aws_subnet.public3.id]
  load_balancers       = [aws_elb.elb.id]
}

5. Outputs 

output "url" {
  value = data.aws_s3_bucket.bucket.bucket_domain_name
}
output "file" {
  value = data.aws_s3_bucket_object.my_img.key
}
output "elb_dns_name" {
  value = aws_elb.elb.dns_name
}
```
